<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FX Strat: SMC Trifecta AI</title>
    
    <!-- PWA / iOS Web Clip Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FX Strat">
    <meta name="theme-color" content="#1f2937">
    
    <!-- App Icon (Embedded SVG) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 1024' style='background-color:%2310b981'%3E%3Cpath d='M128 128h768v768H128z' fill='%2310b981'/%3E%3Cpath d='M288 640l160-288 160 192 128-224' stroke='white' stroke-width='64' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lightweight Charts for Candlestick visualization -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', 
                        'secondary': '#1f2937', 
                        'accent': '#f59e0b', 
                        'bullish': '#059669', 
                        'bearish': '#dc2626', 
                        'neutral': '#f59e0b', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
        }
        .container-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            background-color: white;
            padding: 1.5rem;
        }
        .trade-card {
            transition: transform 0.15s ease-in-out;
            border: 2px solid #e5e7eb;
        }
        .trade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px -2px rgba(0, 0, 0, 0.1);
        }
        .button-primary {
            transition: all 0.15s ease-in-out;
        }
        .button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        .loader {
            border-top-color: #f3f4f6;
            border-left-color: #f3f4f6;
            border-right-color: #f3f4f6;
            border-bottom-color: #10b981;
            border-width: 4px;
            border-style: solid;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .history-item:hover {
            background-color: #f9fafb; 
        }
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        .collapsed .chevron-icon {
            transform: rotate(180deg);
        }
        
        /* iOS Install Prompt Styles */
        #ios-install-prompt {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            z-index: 50;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 md:p-8 font-sans min-h-screen pb-24"> 

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-secondary">FX Strat & Order Flow AI</h1>
            <p class="text-lg text-gray-500 mt-2">Strategy: <span class="text-primary font-bold">Pro-Trend SMC</span> (H4 Bias + M15 Entry)</p>
        </header>

        <!-- Configuration & Control Panel -->
        <div class="container-card mb-8">
            <h2 class="text-xl font-semibold text-secondary mb-4 border-b pb-2">Analysis Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                
                <!-- Asset Pair Input -->
                <div class="md:col-span-1">
                    <label for="assetPair" class="block text-sm font-medium text-gray-700 mb-1">Add Custom Asset</label>
                    <input type="text" id="assetPair" placeholder="e.g. BTC/USD" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary uppercase">
                    <p class="text-[10px] text-gray-500 mt-1">Leave blank to run standard list.</p>
                </div>

                <!-- Strategy Context -->
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Validation Mode</label>
                    <div class="p-2 bg-blue-50 text-blue-800 rounded text-sm font-bold border border-blue-200">
                        Pro-Trend Filter (H4)
                    </div>
                </div>

                <!-- Execution Timeframe -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Timeframe</label>
                    <div class="p-2 bg-gray-100 rounded text-sm text-gray-800 font-bold border border-gray-300 font-mono">
                        15-Minute (M15)
                    </div>
                </div>

                 <!-- Reward Ratio -->
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target RR</label>
                    <div class="p-2 bg-green-50 text-green-700 rounded text-sm font-bold border border-green-200">
                        Fixed 3:1
                    </div>
                </div>
            </div>

            <!-- API Key Input -->
            <div class="mt-4">
                <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                <div class="flex space-x-2">
                    <input type="password" id="apiKey" value="" placeholder="Enter your key (Required)" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                    <button id="clearKey" onclick="document.getElementById('apiKey').value = '';" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg text-sm hover:bg-gray-600 transition duration-150">Clear</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                 <!-- Account Size Input -->
                <div>
                    <label for="accountSize" class="block text-sm font-medium text-gray-700 mb-1">Account Size ($, USD)</label>
                    <input type="number" id="accountSize" value="10000" min="1000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                </div>

                <!-- Risk Percentage Input -->
                <div>
                    <label for="riskPct" class="block text-sm font-medium text-gray-700 mb-1">Risk per Trade (%)</label>
                    <input type="number" id="riskPct" value="1" min="0.1" max="10" step="0.1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                </div>
            </div>

            <!-- Run Button -->
            <div class="mt-6">
                <button id="runAnalysisButton" onclick="runBatchAnalysis()" class="w-full flex justify-center items-center px-6 py-3 bg-primary text-white font-bold text-lg rounded-lg shadow-md button-primary disabled:opacity-50 h-full">
                    <span id="buttonText">Run Pro-Trend Scan (M15)</span>
                    <div id="loader" class="loader ml-3 hidden"></div>
                </button>
                <p class="text-xs text-gray-500 mt-1 text-center">Strict Filter: Checks H4/H1 Trend first. Ignores Counter-Trend signals.</p>
            </div>
        </div>

        <!-- All Trade Signals Container (Batch Results) -->
        <div class="container-card mb-6">
            <!-- Toggle Header -->
            <div class="flex justify-between items-center cursor-pointer mb-4 border-b pb-2" onclick="toggleSection('allTradeSignalsContainer', 'signalsChevron')">
                <h2 class="text-2xl font-bold text-secondary select-none">Precision Signals</h2>
                <i id="signalsChevron" data-lucide="chevron-up" class="w-6 h-6 text-gray-500 chevron-icon"></i>
            </div>
            <!-- Collapsible Content -->
            <div id="allTradeSignalsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 transition-all duration-300">
                <p id="initialMessage" class="text-gray-500 col-span-full">Awaiting analysis...</p>
            </div>
        </div>
        
        <!-- Trade History & Performance Dashboard -->
        <div class="container-card mb-6">
            <!-- Toggle Header -->
            <div class="flex justify-between items-center cursor-pointer mb-4 border-b pb-2" onclick="toggleSection('historyContent', 'historyChevron')">
                <div class="flex items-center space-x-4">
                    <h2 class="text-2xl font-bold text-secondary select-none">Performance Tracker</h2>
                    <button onclick="clearHistory(event)" class="px-3 py-1 text-xs font-semibold text-red-600 border border-red-300 rounded hover:bg-red-50">Clear History</button>
                </div>
                <i id="historyChevron" data-lucide="chevron-up" class="w-6 h-6 text-gray-500 chevron-icon"></i>
            </div>

            <div id="historyContent" class="transition-all duration-300">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="p-4 bg-green-100 rounded-lg text-center">
                        <span class="block text-sm font-medium text-green-700">Wins</span>
                        <span id="summary-wins" class="text-3xl font-bold text-green-600">0</span>
                    </div>
                    <div class="p-4 bg-red-100 rounded-lg text-center">
                        <span class="block text-sm font-medium text-red-700">Losses</span>
                        <span id="summary-losses" class="text-3xl font-bold text-red-600">0</span>
                    </div>
                    <div class="p-4 bg-blue-100 rounded-lg text-center">
                        <span class="block text-sm font-medium text-blue-700">Win Rate</span>
                        <span id="summary-accuracy" class="text-3xl font-bold text-blue-600">0%</span>
                    </div>
                </div>

                <div id="trade-history-container" class="space-y-3">
                    <p id="history-placeholder" class="text-gray-500 text-center py-4">No FCR trades tracked yet.</p>
                </div>
            </div>
        </div>

        <!-- Error Message Box -->
        <div id="errorMessage" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
            <p class="font-bold">Analysis Error:</p>
            <p id="errorText"></p>
        </div>
    </div>

    <!-- iOS Install Prompt -->
    <div id="ios-install-prompt" class="hidden">
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <p class="font-bold text-gray-800">Install FX Strat App</p>
                <p class="text-sm text-gray-600 mt-1">Tap the Share button <span class="inline-block mx-1"><i data-lucide="share" class="w-4 h-4 inline"></i></span> below and select <strong>"Add to Home Screen"</strong>.</p>
            </div>
            <button onclick="document.getElementById('ios-install-prompt').style.display='none'" class="text-gray-400 hover:text-gray-600 ml-4">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import { createIcons, Play, RefreshCw, XCircle, BarChart, TrendingUp, TrendingDown, ChevronUp, ChevronDown, CheckCircle, AlertTriangle, Share, X, Zap, Target, Clock, ArrowRight } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
        
        const iconSet = {
            Play, RefreshCw, XCircle, BarChart, TrendingUp, TrendingDown, ChevronUp, ChevronDown, CheckCircle, AlertTriangle, Share, X, Zap, Target, Clock, ArrowRight
        };

        window.lucide = { 
            createIcons: () => {
                createIcons({ icons: iconSet, attrs: { width: 24, height: 24 } });
            }
        };
        
        window.lucide.createIcons();
    </script>

    <script>
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        let userApiKey = ""; 

        const TRADE_HISTORY_KEY = 'fxAnalystTradeHistory_FCR';
        let tradeHistory = []; 

        const ALL_PAIRS = [
            { pair: 'EUR/USD', base: 1.0850, precision: 4 },
            { pair: 'USD/JPY', base: 150.50, precision: 2 },
            { pair: 'GBP/USD', base: 1.2580, precision: 4 },
            { pair: 'AUD/USD', base: 0.6500, precision: 4 },
            { pair: 'NZD/USD', base: 0.6050, precision: 4 },
            { pair: 'USD/CAD', base: 1.3600, precision: 4 },
            { pair: 'USD/CHF', base: 0.9000, precision: 4 },
            { pair: 'EUR/JPY', base: 163.35, precision: 2 },
            { pair: 'XAU/USD', base: 2350.00, precision: 2 },
        ];

        const apiKeyInput = document.getElementById('apiKey');
        const runAnalysisButton = document.getElementById('runAnalysisButton');
        const buttonText = document.getElementById('buttonText');
        const loader = document.getElementById('loader');
        const allTradeSignalsContainer = document.getElementById('allTradeSignalsContainer');
        const errorMessageDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const tradeHistoryContainer = document.getElementById('trade-history-container');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const summaryWins = document.getElementById('summary-wins');
        const summaryLosses = document.getElementById('summary-losses');
        const summaryAccuracy = document.getElementById('summary-accuracy');
        const accountSizeInput = document.getElementById('accountSize');
        const riskPctInput = document.getElementById('riskPct');
        const assetPairInput = document.getElementById('assetPair');
        
        window.toggleSection = function(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            const headerDiv = icon.parentElement;
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                headerDiv.classList.remove('collapsed');
            } else {
                content.classList.add('hidden');
                headerDiv.classList.add('collapsed');
            }
        };

        // --- Utility Functions ---
        
        // --- MISSING UI HELPER FUNCTIONS RESTORED ---
        function showLoader() {
            runAnalysisButton.disabled = true;
            buttonText.textContent = 'Scanning: H4 Trend + M15 Sweep...';
            loader.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            allTradeSignalsContainer.innerHTML = `<p class="text-primary font-semibold col-span-full animate-pulse">Running Pro-Trend Filter (H4 Bias -> M15 Entry)...</p>`;
            document.getElementById('allTradeSignalsContainer').classList.remove('hidden');
            document.getElementById('signalsChevron').parentElement.classList.remove('collapsed');
        }

        function hideLoader(originalText = 'Run Pro-Trend Scan (M15)') {
            runAnalysisButton.disabled = false;
            buttonText.textContent = originalText;
            loader.classList.add('hidden');
        }

        function handleError(message) {
            errorText.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            hideLoader();
        }
        // ---------------------------------------------


        function extractJson(text) {
            let cleanText = text.replace(/```json/g, '').replace(/```/g, '');
            const startIndex = cleanText.indexOf('{');
            const endIndex = cleanText.lastIndexOf('}');
            if (startIndex === -1 || endIndex === -1 || endIndex <= startIndex) {
                console.error("Failed to find valid JSON object in text:", text);
                throw new Error("Response did not contain a valid JSON object.");
            }
            return cleanText.substring(startIndex, endIndex + 1);
        }

        async function fetchWithRetry(url, options, maxRetries = 3, timeout = 20000) {
            for (let i = 0; i < maxRetries; i++) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);

                try {
                    const response = await fetch(url, { ...options, signal: controller.signal });
                    clearTimeout(id); 

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) { 
                            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i))); 
                            continue;
                        } else if (response.status === 400) {
                            const errorBody = await response.json().catch(() => ({error: { message: 'No detailed error body.' }}));
                            throw new Error(`HTTP 400: ${errorBody.error?.message || 'Bad Request'}`);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    clearTimeout(id); 
                    if (error.name === 'AbortError') {
                         if (i < maxRetries - 1) continue;
                         throw new Error(`Request timed out after ${timeout/1000}s`);
                    }
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        const round = (num, dp) => Math.round(num * Math.pow(10, dp)) / Math.pow(10, dp);
        
        function calculatePipDistance(price1, price2, precision) {
            const diff = Math.abs(parseFloat(price1) - parseFloat(price2));
            const multiplier = (precision === 2) ? 100 : 10000;
            return round(diff * multiplier, 1);
        }

        function calculateLotSize(accountSize, riskPct, entry, stopLoss, pair) {
            const pipDistance = calculatePipDistance(entry, stopLoss, pair.precision);
            const accountRisk = accountSize * (riskPct / 100); 
            if (pipDistance <= 0) return { lotSize: 0, maxLoss: 0, pipDistance: 0 };
            let pipValuePerLot = 10.0; 
            if (pair.pair.includes('JPY')) pipValuePerLot = 7.5; 
            else if (pair.pair.startsWith('USD/')) pipValuePerLot = 7.5; 
            else if (pair.pair.startsWith('XAU/')) pipValuePerLot = 10.0;
            const lotSizeRequired = (accountRisk / pipDistance) / pipValuePerLot;
            let lotSize = Math.max(0.01, round(lotSizeRequired, 2));
            return { lotSize: lotSize.toFixed(2), maxLoss: accountRisk.toFixed(2), pipDistance: pipDistance.toFixed(1) };
        }

        // --- Visualization & UI Functions (Defined BEFORE Usage) ---

        function generateOHLCData(currentPriceStr, pairDef, signalType, count = 35) {
            const data = [];
            let time = Math.floor(Date.now() / 1000) - (count * 60); 
            let current = parseFloat(currentPriceStr);
            const precision = pairDef.precision;
            const isGold = pairDef.pair === 'XAU/USD';
            const baseVol = isGold ? 6.0 : (current * 0.002); 
            
            // Sweep Logic Visualization
            let rangeHigh = current + (baseVol * 2);
            let rangeLow = current - (baseVol * 2);
            
            if (signalType.includes('LONG')) {
                 // Price swept low then came back up
                 rangeHigh = current + (baseVol * 2);
                 rangeLow = current - (baseVol * 1.5); // Current is higher than the sweep low
            } else if (signalType.includes('SHORT')) {
                 rangeLow = current - (baseVol * 2); 
                 rangeHigh = current + (baseVol * 1.5); // Current is lower than sweep high
            }

            let open = rangeLow + (rangeHigh - rangeLow)/2;
            let close = open;
            let high = open;
            let low = open;

            for (let i = 0; i < count; i++) {
                let vol = baseVol;
                
                // Simulate Sweep Candle near the end
                if (!signalType.includes('NEUTRAL') && i === count - 8) {
                     vol = baseVol * 3.5; // Huge wick candle
                }

                let change = (Math.random() - 0.5) * vol;
                
                // If trending, add bias
                if (signalType.includes('LONG') && i > count - 8) change += (vol * 0.4);
                if (signalType.includes('SHORT') && i > count - 8) change -= (vol * 0.4);

                close = open + change;
                high = Math.max(open, close) + (Math.random() * vol * 0.8);
                low = Math.min(open, close) - (Math.random() * vol * 0.8);

                data.push({
                    time: time,
                    open: parseFloat(open.toFixed(precision)),
                    high: parseFloat(high.toFixed(precision)),
                    low: parseFloat(low.toFixed(precision)),
                    close: parseFloat(close.toFixed(precision)),
                });

                open = close;
                time += 60;
            }
            return { data, rangeHigh, rangeLow };
        }


        function renderCandlestickChart(pairId, ohlcData, rangeHigh, rangeLow, tradeData, precision) {
            const container = document.getElementById(`chart-container-${pairId}`);
            if (!container) return;

            if (window[`lwChart_${pairId}`]) {
                window[`lwChart_${pairId}`].remove();
                delete window[`lwChart_${pairId}`];
            }
            
            container.innerHTML = ''; 

            try {
                const chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 200, 
                    layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#333' },
                    grid: { vertLines: { visible: false }, horzLines: { color: '#f0f3fa' } },
                    rightPriceScale: { borderVisible: false },
                    timeScale: { borderVisible: false, timeVisible: true },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                });

                window[`lwChart_${pairId}`] = chart;

                const candleSeries = chart.addCandlestickSeries({
                    upColor: '#10b981', downColor: '#ef4444', 
                    borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#ef4444' 
                });

                candleSeries.setData(ohlcData);

                // Add Liquidity Lines
                const highLine = chart.addLineSeries({ color: 'rgba(220, 38, 38, 0.4)', lineWidth: 1, lineStyle: 2, title: 'Buyside Liq (High)' });
                highLine.setData(ohlcData.map(d => ({ time: d.time, value: rangeHigh })));
                
                const lowLine = chart.addLineSeries({ color: 'rgba(16, 185, 129, 0.4)', lineWidth: 1, lineStyle: 2, title: 'Sellside Liq (Low)' });
                lowLine.setData(ohlcData.map(d => ({ time: d.time, value: rangeLow })));

                if (!tradeData.overallSignal.includes('NEUTRAL')) {
                    const sweepCandle = ohlcData[ohlcData.length - 8]; 
                    candleSeries.setMarkers([{
                        time: sweepCandle.time,
                        position: tradeData.overallSignal.includes('LONG') ? 'belowBar' : 'aboveBar',
                        color: '#f59e0b',
                        shape: tradeData.overallSignal.includes('LONG') ? 'arrowUp' : 'arrowDown',
                        text: 'LIQ SWEEP'
                    }]);
                }

                chart.timeScale().fitContent();
            } catch (err) {
                console.error("Chart Rendering Error:", err);
                container.innerHTML = `<div class="flex items-center justify-center h-full text-xs text-red-400">Chart Error</div>`;
            }
        }

        function createTradeCard(pairId, tradeData, sources, lotSizeData) {
            let recClass = 'bg-yellow-50 border-yellow-300'; 
            let recTextColor = 'text-accent';
            let overallSignal = tradeData.overallSignal.toUpperCase();
            const confidence = tradeData.confidence || 50;
            const isHighConfidence = confidence >= 80; // INCREASED THRESHOLD FOR PRO-TREND

            if (overallSignal.includes('LONG') || overallSignal.includes('BUY')) {
                recClass = 'bg-green-50 border-green-300';
                recTextColor = 'text-green-600';
            } else if (overallSignal.includes('SHORT') || overallSignal.includes('SELL')) {
                recClass = 'bg-red-50 border-red-300';
                recTextColor = 'text-red-600';
            } else {
                 recClass = 'bg-gray-50 border-gray-300';
                 recTextColor = 'text-gray-600';
            }

            if (!isHighConfidence) {
                recClass = 'bg-gray-100 border-gray-300 opacity-90';
                recTextColor = 'text-gray-600';
            }
            
            const escapedTradeData = encodeURIComponent(JSON.stringify(tradeData));
            const showTracking = !overallSignal.includes('NEUTRAL') && !overallSignal.includes('NO TRADE') && isHighConfidence;

            const biasHtml = `
                <div class="grid grid-cols-2 gap-2 mb-2 text-[10px]">
                    <div class="bg-gray-50 p-1 rounded border text-center">
                        <span class="block font-bold text-gray-500">H4 Trend</span>
                        <span class="font-bold ${tradeData.macroBias.includes('BULL') ? 'text-green-600' : (tradeData.macroBias.includes('BEAR') ? 'text-red-600' : 'text-yellow-600')}">${tradeData.macroBias}</span>
                    </div>
                    <div class="bg-gray-50 p-1 rounded border text-center">
                        <span class="block font-bold text-gray-500">OB Structure</span>
                        <span class="font-bold ${tradeData.orderFlowBias.includes('BULL') ? 'text-green-600' : (tradeData.orderFlowBias.includes('BEAR') ? 'text-red-600' : 'text-yellow-600')}">${tradeData.orderFlowBias}</span>
                    </div>
                </div>
            `;

            const smcDetailsHtml = `
                <div class="grid grid-cols-3 gap-1 mt-2 mb-2 bg-white bg-opacity-60 p-2 rounded border border-gray-200 text-[9px] text-center">
                    <div class="flex flex-col items-center justify-center p-1 ${tradeData.smcConfluence.sweep ? 'bg-green-100 text-green-700' : 'bg-red-50 text-red-300'} rounded">
                        <i data-lucide="zap" width="12" class="mb-1"></i>
                        <span class="font-bold">SWEEP</span>
                    </div>
                    <div class="flex flex-col items-center justify-center p-1 ${tradeData.smcConfluence.displacement ? 'bg-green-100 text-green-700' : 'bg-red-50 text-red-300'} rounded">
                        <i data-lucide="trending-up" width="12" class="mb-1"></i>
                        <span class="font-bold">DISPLACE</span>
                    </div>
                    <div class="flex flex-col items-center justify-center p-1 ${tradeData.smcConfluence.orderBlock ? 'bg-green-100 text-green-700' : 'bg-red-50 text-red-300'} rounded">
                        <i data-lucide="target" width="12" class="mb-1"></i>
                        <span class="font-bold">ORDER BLOCK</span>
                    </div>
                </div>
            `;
            
            const citationHtml = sources.map((source, index) => `
                <a href="${source.uri}" target="_blank" class="text-blue-500 hover:text-blue-700 hover:underline text-[10px] truncate block" title="${source.title}">
                    <span class="font-semibold">Source ${index + 1}:</span> ${source.title}
                </a>
            `).join('');

            return `
                <div class="trade-card ${recClass} p-4 rounded-lg shadow-xl flex flex-col h-full relative">
                    ${!isHighConfidence ? '<div class="absolute top-2 right-2 px-2 py-0.5 bg-gray-200 text-gray-600 text-[10px] rounded font-bold">Weak Signal</div>' : '<div class="absolute top-2 right-2 px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded font-bold flex items-center gap-1"><i data-lucide="zap" width="10"></i> HTF ALIGNED</div>'}
                    <div class="absolute top-2 left-2 px-1.5 py-0.5 bg-gray-800 text-white text-[9px] rounded font-mono font-bold flex items-center gap-1 opacity-70">
                        <i data-lucide="clock" width="8"></i> TF: 15m
                    </div>
                    
                    <div class="flex justify-between items-start mb-2 border-b pb-2 pt-4">
                        <h3 class="text-2xl font-bold ${recTextColor}">${tradeData.asset}</h3>
                        <p class="text-sm font-semibold text-gray-700 bg-white px-2 py-1 rounded-full">${tradeData.currentPrice}</p>
                    </div>
                    
                    <div class="text-center mb-1">
                         <p class="text-lg font-extrabold ${recTextColor}">${tradeData.overallSignal}</p>
                    </div>

                    ${biasHtml}
                    ${smcDetailsHtml}

                    <div class="text-center text-xs font-bold text-gray-500 mb-2">Confidence Score: <span class="${isHighConfidence ? 'text-green-600' : 'text-red-500'}">${confidence}%</span></div>

                    ${showTracking ? `
                    <div class="grid grid-cols-3 text-center text-xs font-semibold gap-1 mb-3">
                        <div class="p-1 bg-blue-100 rounded-md">Entry (OB): ${tradeData.entry}</div>
                        <div class="p-1 bg-green-100 rounded-md">TP (3R): ${tradeData.takeProfit}</div>
                        <div class="p-1 bg-red-100 rounded-md">SL: ${tradeData.stopLoss}</div>
                    </div>
                     <!-- Risk Display -->
                    <div class="bg-white p-2 rounded border border-gray-200 mb-2 text-xs flex justify-between">
                        <span>Lots: <strong>${lotSizeData.lotSize}</strong></span>
                        <span>Risk: <strong>$${lotSizeData.maxLoss}</strong></span>
                    </div>
                    <div class="w-full h-52 mb-3 bg-white border border-gray-200 rounded-md p-1" id="chart-container-${pairId}">
                         <!-- Chart injects here -->
                    </div>
                    ` : `
                     <div class="w-full h-24 mb-3 bg-white bg-opacity-50 border border-gray-200 rounded-md p-4 flex flex-col items-center justify-center text-center">
                        <p class="text-gray-500 font-bold text-sm mb-1">Trade Inhibited</p>
                        <p class="text-gray-400 text-xs">Signal failed strict H4 Trend Alignment or Confidence Threshold.</p>
                    </div>
                    `}
                    
                    <div class="flex-grow">
                        <div class="space-y-2 text-xs italic">
                            <p class="text-gray-700"><strong>AI Logic:</strong> ${tradeData.signalRationale}</p>
                        </div>
                    </div>

                    ${showTracking ? `
                    <button 
                        class="track-trade-btn w-full mt-2 px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition"
                        data-trade-json="${escapedTradeData}"
                    >
                        Track SMC Trade
                    </button>
                    ` : ''}
                    
                    <div class="border-t pt-2 mt-2 space-y-0.5">
                         <h5 class="text-[10px] font-bold text-gray-500">Grounded Sources:</h5>
                         ${citationHtml || '<p class="text-[10px] text-gray-400">No sources.</p>'}
                    </div>

                </div>
            `;
        }

        // --- Trade Display Function (Defined BEFORE runBatchAnalysis) ---
        function displayAllTradeSignals(results) {
            allTradeSignalsContainer.innerHTML = ''; 
            const successfulResults = [];
            
            const accountSize = parseFloat(document.getElementById('accountSize').value) || 10000;
            const riskPct = parseFloat(document.getElementById('riskPct').value) || 1;

            results.forEach((result, index) => {
                const pairId = `pair-${index}`;
                if (result.status === 'fulfilled') {
                    const { tradeData, sources, pairDefinition } = result.value;
                    
                    let lotSizeData = { lotSize: '0', maxLoss: '0' };
                    // Only calc lots if high confidence
                    if (!tradeData.overallSignal.includes('NEUTRAL') && (tradeData.confidence || 0) >= 80) { // INCREASED THRESHOLD
                        lotSizeData = calculateLotSize(accountSize, riskPct, tradeData.entry, tradeData.stopLoss, pairDefinition);
                    }
                    
                    const cardHtml = createTradeCard(pairId, tradeData, sources, lotSizeData);
                    allTradeSignalsContainer.innerHTML += cardHtml;
                    successfulResults.push(result);
                    
                     if (!tradeData.overallSignal.includes('NEUTRAL') && (tradeData.confidence || 0) >= 80) {
                        const { data, rangeHigh, rangeLow } = generateOHLCData(tradeData.currentPrice, pairDefinition, tradeData.overallSignal);
                        setTimeout(() => renderCandlestickChart(pairId, data, rangeHigh, rangeLow, tradeData, pairDefinition.precision), 100);
                    }
                    // Re-init icons for injected HTML
                    setTimeout(() => { if (window.lucide && window.lucide.createIcons) window.lucide.createIcons(); }, 50);

                } else {
                    const pairData = ALL_PAIRS[index] || { pair: 'Custom' };
                     allTradeSignalsContainer.innerHTML += `
                        <div class="trade-card bg-red-50 border-red-300 p-4 rounded-lg shadow-xl flex flex-col h-full justify-center items-center">
                            <h3 class="text-xl font-bold text-red-600">${pairData.pair}</h3>
                            <p class="text-xs text-red-600 mt-1 text-center">Analysis Failed: ${result.reason?.message || 'Unknown error'}</p>
                        </div>`;
                }
            });
        }
        
        // --- Explicitly attach to window for robustness ---
        window.displayAllTradeSignals = displayAllTradeSignals;


        // --- Core API Call ---

        function generatePayload(pair) {
             const systemPrompt = `You are an elite Smart Money Concepts (SMC) AI.
            **CRITICAL: Output ONLY a valid JSON object.**

            **STRATEGY UPGRADE: PRO-TREND SMC (H4 Bias + M15 Entry)**
            We are filtering out low-quality counter-trend trades to increase Win Rate.
            
            **STEP 0: HTF TREND FILTER (Crucial)**
            - Analyze the **4-Hour (H4) and 1-Hour (H1)** charts.
            - IF H4 is BULLISH -> ONLY LOOK FOR LONGS. (Ignore sell signals).
            - IF H4 is BEARISH -> ONLY LOOK FOR SHORTS. (Ignore buy signals).
            - IF H4 is SIDEWAYS -> OUTPUT NEUTRAL (No Trade).

            **STEP 1: THE M15 SETUP (Only if HTF aligns)**
            - **Trap:** Liquidity Sweep of a key High/Low on M15.
            - **Move:** Displacement (Strong move reversing away).
            - **Entry:** Order Block (OB) created by that displacement.
            
            **SIGNAL GENERATION:**
            - **LONG:** H4 BULLISH + M15 Low Swept + Displacement Up + Bullish OB. 
              - Stop Loss: BELOW Sweep Low + 10-15 PIPS BUFFER.
            - **SHORT:** H4 BEARISH + M15 High Swept + Displacement Down + Bearish OB. 
              - Stop Loss: ABOVE Sweep High + 10-15 PIPS BUFFER.
            
            **MANDATORY:** Use Google Search to find Real-Time Price.

            **SCORING (+100 Total):**
            - +40 H4/H1 Trend Alignment (Must be present).
            - +20 Liquidity Sweep Confirmed.
            - +20 Displacement Verified.
            - +20 Valid Order Block Identified.
            - **Threshold: < 80 = NEUTRAL.** (Strict grading).

            **JSON SCHEMA (Strictly Follow):**
            {
              "asset": "String (e.g., EUR/USD)",
              "overallSignal": "LONG / SHORT / NEUTRAL",
              "macroBias": "BULLISH / BEARISH / NEUTRAL",
              "orderFlowBias": "BULLISH / BEARISH / NEUTRAL",
              "correlation": "Confirmed / Divergence",
              "confidence": Integer (0-100),
              "smcConfluence": { "sweep": Boolean, "displacement": Boolean, "orderBlock": Boolean },
              "signalRationale": "String (Focus on H4 Trend Alignment + M15 Entry)",
              "entry": "Number String",
              "stopLoss": "Number String",
              "takeProfit": "Number String",
              "currentPrice": "Number String"
            }`;

            const timestamp = new Date().toISOString();
            const userQuery = `
            Analyze ${pair} for PRO-TREND SMC (H4 Trend + M15 Entry) as of ${timestamp}.
            Find real-time price first.
            NO TEXT. NO EXPLANATIONS. JSON ONLY.
            `;

            return {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }],
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                ]
            };
        }

        async function fetchFundamentalAnalysis(pairDefinition) {
            const payload = generatePayload(pairDefinition.pair);
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${encodeURIComponent(userApiKey)}`;
            
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (!candidate || !candidate.content || !candidate.content.parts || !candidate.content.parts[0] || !candidate.content.parts[0].text) {
                console.error("Gemini API Response Error Dump:", JSON.stringify(result, null, 2));
                throw new Error("Invalid API response.");
            }

            const text = candidate.content.parts[0].text;
            const jsonString = extractJson(text);
            const tradeData = JSON.parse(jsonString);

            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                    .filter(source => source.uri && source.title);
            }
            return { tradeData, sources, pairDefinition };
        }

        async function runBatchAnalysis() {
            userApiKey = apiKeyInput.value.trim(); 
            if (!userApiKey) {
                handleError("Gemini API Key is required.");
                return;
            }
            
            const customPairInput = document.getElementById('assetPair').value.trim().toUpperCase();
            let batchPairs = [...ALL_PAIRS]; 

            if (customPairInput && customPairInput.length >= 3) {
                let formattedPair = customPairInput;
                if (!formattedPair.includes('/') && formattedPair.length === 6) {
                     formattedPair = formattedPair.slice(0, 3) + '/' + formattedPair.slice(3);
                }
                let precision = 4;
                if (formattedPair.includes('JPY') || formattedPair.includes('XAU')) precision = 2;
                batchPairs.unshift({ pair: formattedPair, precision: precision, isCustom: true });
            }

            showLoader();
            buttonText.textContent = 'Scanning all pairs simultaneously...'; 
            
            // Parallel Execution: Map each pair to a promise
            const promises = batchPairs.map(async (pairDef) => {
                try {
                    const result = await fetchFundamentalAnalysis(pairDef);
                    return { status: 'fulfilled', value: result };
                } catch (error) {
                    if (!error.pair) error.pair = pairDef.pair;
                    return { status: 'rejected', reason: { message: error.message, pair: pairDef.pair } };
                }
            });

            // Wait for all promises to resolve/reject concurrently
            const allResults = await Promise.all(promises);

            // Check for critical API key failure
            const criticalFailure = allResults.find(r => r.status === 'rejected' && r.reason && (r.reason.message.includes('API key') || r.reason.message.includes('400')));
            if (criticalFailure && allResults.every(r => r.status === 'rejected')) {
                 handleError(`Critical Error: ${criticalFailure.reason.message}`);
                 hideLoader();
                 return;
            }

            if (allResults.length > 0) {
                // Ensure displayAllTradeSignals exists before calling
                if (typeof displayAllTradeSignals === 'function') {
                    displayAllTradeSignals(allResults);
                } else if (typeof window.displayAllTradeSignals === 'function') {
                     window.displayAllTradeSignals(allResults);
                } else {
                    console.error("displayAllTradeSignals function is missing!");
                    handleError("Internal Error: Display function missing.");
                }
            } else {
                handleError("No results.");
            }
            
            hideLoader();
        }
        
        window.onload = () => {
             if (typeof __GEMINI_API_KEY__ !== 'undefined' && __GEMINI_API_KEY__) apiKeyInput.value = __GEMINI_API_KEY__;
            if (apiKeyInput.value.trim()) runAnalysisButton.disabled = false;
            apiKeyInput.addEventListener('input', (e) => runAnalysisButton.disabled = !e.target.value.trim());
            loadTradeHistory();
            document.body.addEventListener('click', (event) => {
                if (event.target.classList.contains('track-trade-btn')) trackTrade(event.target);
            });
            
            // Check for iOS
            const isIos = /iphone|ipad|ipod/.test( window.navigator.userAgent.toLowerCase() );
            const isInStandaloneMode = ('standalone' in window.navigator) && (window.navigator.standalone);
            
            if (isIos && !isInStandaloneMode) {
                const prompt = document.getElementById('ios-install-prompt');
                if (prompt) {
                    setTimeout(() => {
                        prompt.style.display = 'block';
                    }, 2000);
                }
            }
        };

        // --- History Logic ---
        window.updateTradeStatus = (id, status) => {
            const tradeIndex = tradeHistory.findIndex(t => t.id === id);
            if (tradeIndex > -1) {
                tradeHistory[tradeIndex].status = status;
                saveTradeHistory();
                renderTradeHistory();
            }
        };

        function loadTradeHistory() {
            const stored = localStorage.getItem(TRADE_HISTORY_KEY);
            if (stored) tradeHistory = JSON.parse(stored);
            renderTradeHistory();
        }
        function saveTradeHistory() { localStorage.setItem(TRADE_HISTORY_KEY, JSON.stringify(tradeHistory)); }
        window.clearHistory = (e) => { e.stopPropagation(); if(confirm('Clear history?')) { tradeHistory=[]; saveTradeHistory(); renderTradeHistory(); } };
        function renderTradeHistory() {
            tradeHistoryContainer.innerHTML = '';
            let wins = 0, losses = 0;
            if (tradeHistory.length === 0) tradeHistoryContainer.innerHTML = `<p class="text-gray-500 text-center text-xs">No trades.</p>`;
            else {
                tradeHistory.forEach(t => {
                    if(t.status === 'Win') wins++; if(t.status === 'Loss') losses++;
                    
                    const item = document.createElement('div');
                    item.className = 'p-2 border-b flex justify-between items-center text-xs';
                    
                    let actionsHtml = '';
                    if (t.status === 'Pending') {
                        actionsHtml = `
                            <div class="flex space-x-2">
                                <button onclick="window.updateTradeStatus(${t.id}, 'Win')" class="text-green-600 hover:bg-green-100 p-1 rounded" title="Mark Win">✔</button>
                                <button onclick="window.updateTradeStatus(${t.id}, 'Loss')" class="text-red-600 hover:bg-red-100 p-1 rounded" title="Mark Loss">✘</button>
                            </div>
                        `;
                    } else {
                         actionsHtml = `<span class="font-bold ${t.status === 'Win' ? 'text-green-600' : 'text-red-600'}">${t.status}</span>`;
                    }

                    item.innerHTML = `
                        <div class="flex flex-col">
                            <span class="font-bold">${t.tradeData.overallSignal} ${t.tradeData.asset}</span>
                            <span class="text-[10px] text-gray-500">${new Date(t.id).toLocaleTimeString()}</span>
                        </div>
                        ${actionsHtml}
                    `;
                    tradeHistoryContainer.appendChild(item);
                });
            }
            document.getElementById('summary-wins').textContent = wins;
            document.getElementById('summary-losses').textContent = losses;
            document.getElementById('summary-accuracy').textContent = (wins+losses)>0 ? Math.round((wins/(wins+losses))*100)+'%' : '0%';
        }
        function trackTrade(btn) {
            const data = JSON.parse(decodeURIComponent(btn.dataset.tradeJson));
            tradeHistory.push({ id: Date.now(), tradeData: data, status: 'Pending' });
            saveTradeHistory(); renderTradeHistory();
            btn.textContent = 'Tracked'; btn.disabled = true;
        }

    </script>
</body>
</html>
