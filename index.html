import React, { useState, useEffect, useRef } from 'react';
import { 
  Play, 
  History, 
  Settings, 
  TrendingUp, 
  TrendingDown, 
  Activity, 
  AlertTriangle, 
  CheckCircle, 
  ChevronRight, 
  X,
  Search,
  ArrowUpRight,
  ArrowDownRight,
  Wifi,
  Battery,
  Signal
} from 'lucide-react';

// --- iOS UI Components ---

const IOSHeader = ({ title, rightAction }) => (
  <div className="pt-12 pb-2 px-4 bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200 flex justify-between items-center transition-all duration-300">
    <h1 className="text-2xl font-bold text-gray-900 tracking-tight">{title}</h1>
    {rightAction}
  </div>
);

const IOSStatusBar = () => (
  <div className="fixed top-0 left-0 right-0 h-11 bg-transparent z-50 flex justify-between items-center px-6 text-xs font-semibold text-gray-900 pointer-events-none">
    <span>{new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
    <div className="flex items-center space-x-1.5">
      <Signal size={14} fill="currentColor" />
      <Wifi size={14} />
      <Battery size={18} />
    </div>
  </div>
);

const IOSTabBar = ({ activeTab, setActiveTab }) => (
  <div className="fixed bottom-0 left-0 right-0 h-20 bg-white/90 backdrop-blur-xl border-t border-gray-200 flex justify-around items-start pt-3 pb-8 z-50 shadow-lg">
    <button 
      onClick={() => setActiveTab('scanner')}
      className={`flex flex-col items-center space-y-1 w-16 transition-colors duration-200 ${activeTab === 'scanner' ? 'text-blue-500' : 'text-gray-400'}`}
    >
      <Activity size={24} strokeWidth={activeTab === 'scanner' ? 2.5 : 2} />
      <span className="text-[10px] font-medium">Scanner</span>
    </button>
    <button 
      onClick={() => setActiveTab('history')}
      className={`flex flex-col items-center space-y-1 w-16 transition-colors duration-200 ${activeTab === 'history' ? 'text-blue-500' : 'text-gray-400'}`}
    >
      <History size={24} strokeWidth={activeTab === 'history' ? 2.5 : 2} />
      <span className="text-[10px] font-medium">History</span>
    </button>
    <button 
      onClick={() => setActiveTab('settings')}
      className={`flex flex-col items-center space-y-1 w-16 transition-colors duration-200 ${activeTab === 'settings' ? 'text-blue-500' : 'text-gray-400'}`}
    >
      <Settings size={24} strokeWidth={activeTab === 'settings' ? 2.5 : 2} />
      <span className="text-[10px] font-medium">Settings</span>
    </button>
  </div>
);

// --- Charting Component (SVG) ---

const MobileCandleChart = ({ signalType, width = 300, height = 160 }) => {
  // Generate deterministic but organic-looking candle data based on signal
  const generateData = () => {
    const data = [];
    let price = 100;
    const count = 20;
    
    // Determine trend bias
    let bias = 0;
    if (signalType.includes('LONG') || signalType.includes('BULL')) bias = 0.5;
    else if (signalType.includes('SHORT') || signalType.includes('BEAR')) bias = -0.5;

    for (let i = 0; i < count; i++) {
      let move = (Math.random() - 0.5) * 2 + bias;
      // Force FCR displacement at the end
      if (i > count - 5 && bias !== 0) move = bias * 4; 

      const open = price;
      const close = price + move;
      const high = Math.max(open, close) + Math.random() * 1;
      const low = Math.min(open, close) - Math.random() * 1;
      
      data.push({ open, close, high, low });
      price = close;
    }
    return data;
  };

  const data = generateData();
  const maxPrice = Math.max(...data.map(d => d.high));
  const minPrice = Math.min(...data.map(d => d.low));
  const range = maxPrice - minPrice;
  
  const candleWidth = (width / data.length) * 0.7;
  const gap = (width / data.length) * 0.3;

  const getY = (p) => height - ((p - minPrice) / range) * (height - 20) - 10;

  return (
    <div className="w-full h-40 bg-gray-50 rounded-xl border border-gray-100 overflow-hidden relative">
      <div className="absolute top-2 left-2 text-[10px] text-gray-400 font-mono">1M FCR VIEW</div>
      <svg width="100%" height="100%" viewBox={`0 0 ${width} ${height}`} preserveAspectRatio="none">
        {/* Grid Lines */}
        <line x1="0" y1={height/2} x2={width} y2={height/2} stroke="#e5e7eb" strokeWidth="1" strokeDasharray="4 4" />
        
        {data.map((d, i) => {
          const x = i * (candleWidth + gap) + gap;
          const isGreen = d.close >= d.open;
          const color = isGreen ? '#10b981' : '#ef4444';
          
          return (
            <g key={i}>
              {/* Wick */}
              <line 
                x1={x + candleWidth/2} 
                y1={getY(d.high)} 
                x2={x + candleWidth/2} 
                y2={getY(d.low)} 
                stroke={color} 
                strokeWidth="1" 
              />
              {/* Body */}
              <rect 
                x={x} 
                y={Math.min(getY(d.open), getY(d.close))} 
                width={candleWidth} 
                height={Math.abs(getY(d.open) - getY(d.close)) || 1} 
                fill={color} 
              />
            </g>
          );
        })}
      </svg>
    </div>
  );
};

// --- Logic & Data Handling ---

const App = () => {
  const [activeTab, setActiveTab] = useState('scanner');
  const [apiKey, setApiKey] = useState('');
  const [assetPair, setAssetPair] = useState('');
  const [loading, setLoading] = useState(false);
  const [scanResult, setScanResult] = useState(null);
  const [history, setHistory] = useState([]);
  const [riskPercent, setRiskPercent] = useState(1);
  const [accountSize, setAccountSize] = useState(10000);
  const [error, setError] = useState('');

  // Load data on mount
  useEffect(() => {
    const savedKey = localStorage.getItem('gemini_api_key_ios');
    const savedHistory = localStorage.getItem('fx_history_ios');
    if (savedKey) setApiKey(savedKey);
    if (savedHistory) setHistory(JSON.parse(savedHistory));
    
    // Auto-load embedded key if present
    if (typeof window !== 'undefined' && window.__GEMINI_API_KEY__) {
        setApiKey(window.__GEMINI_API_KEY__);
    }
  }, []);

  const saveSettings = (key, risk, size) => {
    setApiKey(key);
    setRiskPercent(risk);
    setAccountSize(size);
    localStorage.setItem('gemini_api_key_ios', key);
  };

  const runScan = async () => {
    if (!apiKey) {
      setError('Please enter API Key in Settings');
      setActiveTab('settings');
      return;
    }
    if (!assetPair) {
      setError('Enter an asset pair (e.g. EURUSD)');
      return;
    }

    setLoading(true);
    setScanResult(null);
    setError('');

    const systemPrompt = `You are a strict JSON API backend. Output ONLY the raw JSON object.

    **STRATEGY: HYBRID FCR**
    1. **Bias:** Check DXY/News/Structure.
    2. **FCR:** First 5m Candle Break + FVG + Engulfing.
    
    **CONFIDENCE:** Base 50. +20 Macro align. +20 DXY align. +10 News. -50 Conflict.
    Threshold < 75 = NEUTRAL.
    
    **OUTPUT JSON:**
    {
      "asset": "${assetPair.toUpperCase()}",
      "overallSignal": "LONG / SHORT / NEUTRAL",
      "macroBias": "BULLISH / BEARISH / NEUTRAL",
      "orderFlowBias": "BULLISH / BEARISH / NEUTRAL",
      "correlation": "Confirmed / Divergence",
      "confidence": 85,
      "fcrCheck": { "break5m": true, "hasFVG": true, "hasEngulfing": true },
      "signalRationale": "Short rationale.",
      "entry": "1.2345",
      "stopLoss": "1.2300",
      "takeProfit": "1.2400",
      "currentPrice": "1.2350"
    }`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(apiKey)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Analyze ${assetPair}. Return JSON only.` }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          tools: [{ google_search: {} }]
        })
      });

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      
      if (!text) throw new Error("No response from AI");
      
      const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const tradeData = JSON.parse(jsonStr);
      
      setScanResult(tradeData);
      
    } catch (err) {
      console.error(err);
      setError("Analysis Failed: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  const trackTrade = () => {
    if (!scanResult) return;
    const newHistory = [
      { ...scanResult, id: Date.now(), status: 'Pending', timestamp: new Date().toLocaleString() }, 
      ...history
    ];
    setHistory(newHistory);
    localStorage.setItem('fx_history_ios', JSON.stringify(newHistory));
    setActiveTab('history');
  };

  const clearHistory = () => {
      setHistory([]);
      localStorage.removeItem('fx_history_ios');
  }

  // --- Views ---

  const ScannerView = () => (
    <div className="pb-24 animate-in fade-in duration-500">
      <IOSHeader title="Scanner" />
      
      <div className="p-4 space-y-6">
        {/* Input Area */}
        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
          <label className="text-xs font-semibold text-gray-500 uppercase tracking-wider ml-1 mb-2 block">Asset Selection</label>
          <div className="relative">
            <Search className="absolute left-3 top-3 text-gray-400" size={20} />
            <input 
              type="text" 
              value={assetPair}
              onChange={(e) => setAssetPair(e.target.value.toUpperCase())}
              placeholder="e.g. GBP/USD"
              className="w-full pl-10 pr-4 py-3 bg-gray-50 rounded-xl text-lg font-semibold text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
            />
          </div>
          
          <div className="flex gap-2 mt-3 overflow-x-auto no-scrollbar pb-1">
            {['EURUSD', 'GBPUSD', 'XAUUSD', 'USDJPY'].map(p => (
              <button 
                key={p} 
                onClick={() => setAssetPair(p === 'EURUSD' ? 'EUR/USD' : p === 'GBPUSD' ? 'GBP/USD' : p === 'XAUUSD' ? 'XAU/USD' : 'USD/JPY')}
                className="px-3 py-1.5 bg-gray-100 rounded-lg text-xs font-medium text-gray-600 hover:bg-gray-200 active:scale-95 transition-transform"
              >
                {p}
              </button>
            ))}
          </div>

          <button 
            onClick={runScan}
            disabled={loading}
            className={`mt-4 w-full py-3.5 rounded-xl text-white font-bold text-base shadow-lg shadow-blue-500/30 active:scale-95 transition-all flex justify-center items-center ${loading ? 'bg-blue-400' : 'bg-blue-600'}`}
          >
            {loading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" /> : 'Run Hybrid Scan'}
          </button>
          
          {error && <p className="text-red-500 text-xs text-center mt-3 bg-red-50 py-2 rounded-lg">{error}</p>}
        </div>

        {/* Results Card */}
        {scanResult && (
          <div className="bg-white rounded-2xl shadow-xl shadow-gray-200/50 overflow-hidden border border-gray-100 animate-in slide-in-from-bottom-4 duration-500">
             {/* Confidence Header */}
            <div className={`px-4 py-3 flex justify-between items-center ${scanResult.confidence >= 75 ? 'bg-green-50' : 'bg-gray-50'}`}>
              <div className="flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full ${scanResult.confidence >= 75 ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}`} />
                <span className={`text-xs font-bold uppercase tracking-wide ${scanResult.confidence >= 75 ? 'text-green-700' : 'text-gray-500'}`}>
                  {scanResult.confidence >= 75 ? 'High Conviction' : 'Low Conviction'}
                </span>
              </div>
              <span className="text-xl font-black text-gray-800">{scanResult.confidence}%</span>
            </div>

            <div className="p-5">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h2 className="text-3xl font-bold text-gray-900 tracking-tight">{scanResult.asset}</h2>
                  <div className="flex items-center gap-1 mt-1">
                    <span className="text-sm font-medium text-gray-500">Current:</span>
                    <span className="text-sm font-bold text-gray-900">{scanResult.currentPrice}</span>
                  </div>
                </div>
                <div className={`px-3 py-1 rounded-full text-xs font-bold ${
                  scanResult.overallSignal.includes('LONG') ? 'bg-green-100 text-green-700' :
                  scanResult.overallSignal.includes('SHORT') ? 'bg-red-100 text-red-700' :
                  'bg-yellow-100 text-yellow-700'
                }`}>
                  {scanResult.overallSignal}
                </div>
              </div>

              {/* Bias Grid */}
              <div className="grid grid-cols-2 gap-3 mb-4">
                <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                  <span className="text-[10px] uppercase font-bold text-gray-400 block mb-1">Macro Bias</span>
                  <div className="flex items-center gap-1.5">
                    {scanResult.macroBias.includes('BULL') ? <ArrowUpRight size={14} className="text-green-500"/> : <ArrowDownRight size={14} className="text-red-500"/>}
                    <span className="text-xs font-bold text-gray-700">{scanResult.macroBias}</span>
                  </div>
                </div>
                <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                  <span className="text-[10px] uppercase font-bold text-gray-400 block mb-1">Correlation</span>
                  <div className="flex items-center gap-1.5">
                    <Activity size={14} className={scanResult.confidence >= 75 ? "text-blue-500" : "text-yellow-500"}/>
                    <span className="text-xs font-bold text-gray-700">{scanResult.correlation || "Checking..."}</span>
                  </div>
                </div>
              </div>

              {/* Chart */}
              <MobileCandleChart signalType={scanResult.overallSignal} />
              
              {/* FCR Checklist */}
              <div className="flex justify-between items-center my-4 px-2">
                <div className="flex flex-col items-center gap-1">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center ${scanResult.fcrCheck.break5m ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-300'}`}>
                    <CheckCircle size={14} />
                  </div>
                  <span className="text-[9px] font-bold text-gray-400">5m Break</span>
                </div>
                <div className="w-8 h-[1px] bg-gray-200" />
                <div className="flex flex-col items-center gap-1">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center ${scanResult.fcrCheck.hasFVG ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-300'}`}>
                    <CheckCircle size={14} />
                  </div>
                  <span className="text-[9px] font-bold text-gray-400">1m FVG</span>
                </div>
                <div className="w-8 h-[1px] bg-gray-200" />
                <div className="flex flex-col items-center gap-1">
                   <div className={`w-6 h-6 rounded-full flex items-center justify-center ${scanResult.fcrCheck.hasEngulfing ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-300'}`}>
                    <CheckCircle size={14} />
                  </div>
                  <span className="text-[9px] font-bold text-gray-400">Engulfing</span>
                </div>
              </div>

              {/* Execution Details (Only if Valid) */}
              {scanResult.confidence >= 75 ? (
                <div className="space-y-3">
                  <div className="grid grid-cols-3 gap-2">
                     <div className="bg-blue-50 p-2 rounded-lg text-center border border-blue-100">
                       <span className="text-[9px] text-blue-400 font-bold block">ENTRY</span>
                       <span className="text-xs font-bold text-blue-700">{scanResult.entry}</span>
                     </div>
                     <div className="bg-red-50 p-2 rounded-lg text-center border border-red-100">
                       <span className="text-[9px] text-red-400 font-bold block">SL</span>
                       <span className="text-xs font-bold text-red-700">{scanResult.stopLoss}</span>
                     </div>
                     <div className="bg-green-50 p-2 rounded-lg text-center border border-green-100">
                       <span className="text-[9px] text-green-400 font-bold block">TP (3R)</span>
                       <span className="text-xs font-bold text-green-700">{scanResult.takeProfit}</span>
                     </div>
                  </div>
                  <button 
                    onClick={trackTrade}
                    className="w-full py-3 bg-gray-900 text-white rounded-xl font-bold text-sm shadow-lg shadow-gray-500/20 active:scale-95 transition-transform"
                  >
                    Track Trade
                  </button>
                </div>
              ) : (
                <div className="bg-yellow-50 p-3 rounded-xl border border-yellow-100 flex items-center gap-3">
                  <AlertTriangle className="text-yellow-600 shrink-0" size={20} />
                  <p className="text-xs text-yellow-800 font-medium leading-relaxed">
                    Confidence too low. Macro or Structure does not align with FCR. Stand aside.
                  </p>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );

  const HistoryView = () => (
    <div className="pb-24 animate-in fade-in duration-500">
      <IOSHeader 
        title="History" 
        rightAction={
            <button onClick={clearHistory} className="text-xs text-red-500 font-semibold">Clear</button>
        }
      />
      
      <div className="p-4 space-y-3">
        {history.length === 0 ? (
          <div className="text-center mt-20 opacity-50">
             <History size={48} className="mx-auto mb-4 text-gray-300" />
             <p className="text-gray-400 font-medium">No tracked trades yet.</p>
          </div>
        ) : (
          history.map(item => (
            <div key={item.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
              <div>
                <div className="flex items-center gap-2 mb-1">
                    <h3 className="font-bold text-gray-900">{item.asset}</h3>
                    <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${
                         item.overallSignal.includes('LONG') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                    }`}>{item.overallSignal}</span>
                </div>
                <p className="text-xs text-gray-400">{item.timestamp}</p>
              </div>
              <div className="text-right">
                <span className={`text-sm font-bold block ${item.status === 'Win' ? 'text-green-500' : item.status === 'Loss' ? 'text-red-500' : 'text-gray-400'}`}>
                    {item.status}
                </span>
                {item.status === 'Pending' && (
                    <div className="flex gap-1 mt-1">
                        <button onClick={() => {
                            const updated = history.map(h => h.id === item.id ? {...h, status: 'Win'} : h);
                            setHistory(updated);
                            localStorage.setItem('fx_history_ios', JSON.stringify(updated));
                        }} className="w-6 h-6 bg-green-100 rounded flex items-center justify-center text-green-600">W</button>
                        <button onClick={() => {
                             const updated = history.map(h => h.id === item.id ? {...h, status: 'Loss'} : h);
                             setHistory(updated);
                             localStorage.setItem('fx_history_ios', JSON.stringify(updated));
                        }} className="w-6 h-6 bg-red-100 rounded flex items-center justify-center text-red-600">L</button>
                    </div>
                )}
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );

  const SettingsView = () => (
    <div className="pb-24 animate-in fade-in duration-500">
      <IOSHeader title="Settings" />
      
      <div className="p-4 space-y-6">
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <div className="p-4 border-b border-gray-100">
            <label className="text-xs font-bold text-gray-400 uppercase mb-2 block">Gemini API Key</label>
            <input 
              type="password" 
              value={apiKey}
              onChange={(e) => saveSettings(e.target.value, riskPercent, accountSize)}
              placeholder="Paste Key Here"
              className="w-full text-base text-gray-900 placeholder-gray-300 focus:outline-none"
            />
          </div>
          <div className="p-4 flex justify-between items-center">
            <span className="text-sm font-medium text-gray-700">Risk per Trade</span>
            <div className="flex items-center gap-2">
                <input 
                  type="number" 
                  value={riskPercent}
                  onChange={(e) => saveSettings(apiKey, e.target.value, accountSize)}
                  className="w-12 text-right text-sm font-bold text-blue-600 focus:outline-none"
                />
                <span className="text-gray-400">%</span>
            </div>
          </div>
          <div className="p-4 border-t border-gray-100 flex justify-between items-center">
            <span className="text-sm font-medium text-gray-700">Account Size</span>
            <div className="flex items-center gap-2">
                <span className="text-gray-400">$</span>
                <input 
                  type="number" 
                  value={accountSize}
                  onChange={(e) => saveSettings(apiKey, riskPercent, e.target.value)}
                  className="w-20 text-right text-sm font-bold text-gray-900 focus:outline-none"
                />
            </div>
          </div>
        </div>

        <div className="text-center">
            <p className="text-xs text-gray-400 mb-1">Strategy Version</p>
            <p className="text-sm font-bold text-gray-600">Hybrid FCR v2.1 (Mobile)</p>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900 selection:bg-blue-100">
      <IOSStatusBar />
      
      {activeTab === 'scanner' && <ScannerView />}
      {activeTab === 'history' && <HistoryView />}
      {activeTab === 'settings' && <SettingsView />}

      <IOSTabBar activeTab={activeTab} setActiveTab={setActiveTab} />
    </div>
  );
};

export default App;
